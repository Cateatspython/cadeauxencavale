{% extends '/pages/base.html' %}

{% block title %}Recherche d'objets trouvÃ©s{% endblock %}

{% block content %}

{% set all_messages = get_flashed_messages(with_categories=true) %}

{% set general_messages = [] %}
{% set favori_messages = [] %}

{% for category, message in all_messages %}
    {% if "favori" in category %}
        {% set _ = favori_messages.append((category, message)) %}
    {% else %}
        {% set _ = general_messages.append((category, message)) %}
    {% endif %}
{% endfor %}

<h1 class="my-3 text-center">Recherche d'objets trouvÃ©s</h1>

<div class="card m-5 p-4">
    <h5 class="card-header">
        <a data-toggle="collapse" href="#collapse-example" aria-expanded="true" aria-controls="collapse-example" id="heading-example" class="d-block">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
            </svg>
            PrÃ©sentation
        </a>
    </h5>
    <div id="collapse-example" class="collapse show" aria-labelledby="heading-example">
        <div class="card-body">
            <p>Vous avez Ã©garÃ© un objet en gare ou durant un trajet ? Pas de panique, ce formulaire est lÃ  pour vous aider !<br/>    
            <span class="font-weight-bold">ğŸ‘œ Type dâ€™objet</span><br/>
            Commencez par sÃ©lectionner le type dâ€™objet perdu dans la liste dÃ©roulante.<br/>
            
            <span class="font-weight-bold">ğŸš‰ Gare(s) concernÃ©e(s)</span><br/>
            
                Si vous savez oÃ¹ vous avez perdu votre objet, choisissez une seule gare.<br/>
            
                Si vous lâ€™avez perdu en voyage, sÃ©lectionnez la gare de dÃ©part et celle dâ€™arrivÃ©e.<br/>
                Tapez le nom dâ€™une gare, laissez-vous guider par lâ€™autocomplÃ©tion, et cliquez sur le nom choisi suggÃ©rÃ© par l'autocomplÃ©tion. Cliquez ensuite en dehors de la case pour valider la sÃ©lection. Elle sâ€™affichera en dessous avec une croix pour la retirer si besoin.<br/>
            
            <span class="font-weight-bold">ğŸ“… Date du trajet</span><br/>
            Indiquez la date Ã  laquelle vous avez perdu votre objet, entre le 20 dÃ©cembre 2024 et le 6 janvier 2025.<br/>
            
            <span class="font-weight-bold">â³ Heure approximative de perte</span><br/>
            Pas besoin dâ€™Ãªtre prÃ©cis Ã  la minute prÃ¨s ! Une estimation suffira.<br/>
            
            ğŸ’¡ Une fois le formulaire soumis, vous pourrez voir combien dâ€™objets du type sÃ©lectionnÃ© ont Ã©tÃ© retrouvÃ©s dans la ou les gares choisies, depuis la date et lâ€™heure indiquÃ©es jusquâ€™Ã  la fin des vacances de NoÃ«l 2024-2025. Bonne recherche ! ğŸ„ğŸ”</p>
        </div>
    </div>
</div>

<!-- Affichage des messages flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="alert-container mt-3 text-center mx-5">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="alert-container mt-3 text-center mx-5"></div>

{% include '/partials/formulaires/form_trouver_objet.html' %}

<script>
    document.querySelector("form").addEventListener("submit", function() {
    console.log("Valeur des gares soumises :", document.getElementById("hidden-gares").value);
    });
</script>

<div class="m-5">
    <div id="map" style="height: 400px; width: 100%;"></div>
    {% include '/partials/scripts/script_carte_leaflet.html' %}
</div>

<div class="m-5 mx-auto container justify-content-around w-100">

<!-- Affichage des donnÃ©es des gares -->
{% if donnees %}
        <div class="text-center">
            <h1>RÃ©sultats</h1>
        </div>
        <!-- ItÃ©ration sur la liste de dictionnaires donnees -->
        {% for gare in donnees %}
        <div class="row mb-5 align-items-start">
            <div class="col-md-6">
                <h2>{{ gare.nom }}</h2>
                <button class="ajout-favoris-btn btn mb-3" data-uic="{{ gare.UIC }}">Ajouter la gare aux favoris</button>
                <p><strong>Adresse</strong> : {{ gare.adresse }}</p>
                <p><strong>Nombre d'objets trouvÃ©s pendant la pÃ©riode</strong> : {{ gare.nb_objets_trouves_periode_perte_type }}</p>
            </div>
                
            <div class="col-md-6">
                <!-- Affichage des horaires seulement si la gare en a -->
                {% set jours_ordre = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"] %}
                {% if gare.horaires %}
                <h3>Horaires</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Jour</th>
                            <th>Horaires (Jour Normal)</th>
                            <th>Horaires (Jour FÃ©riÃ©)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for jour in jours_ordre %}
                        {% if gare.horaires.get(jour) %}
                            <tr>
                                <td>{{ jour }}</td>
                                <td>{{ gare.horaires[jour].get("horaires_jour_normal", "Non disponible") }}</td>
                        <td>{{ gare.horaires[jour].get("horaires_jour_ferie", "Non disponible") }}</td>
                            </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
            </div>
    </div>

        <!-- Graphique de rÃ©partition des objets trouvÃ©s par type pour la gare itÃ©rÃ©e-->
        <div class="row justify-content-center mb-4">
            {% if gare.nb_objets_trouves_periode_perte_type > 0 %}
                <div class="col-6">
                    <h3>RÃ©partition des objets trouvÃ©s par type - {{ gare.nom }}</h3>
                    <canvas id="graphiqueCamembert_{{ gare.UIC }}" style="width: 100%; max-width: 800px; max-height: 600px;"></canvas>
                </div>
            {% endif %}
        </div>
        {% endfor %}

        <!-- Inclusion du script pour le graphique camembert -->
        {% include '/partials/graphiques/graphique_1_camembert.html' %}

        <!-- Graphique des objets trouvÃ©s par type, par rÃ©gion -->
        
        <div class="row row mt-4 justify-content-center">
            <div class="col-10 text-center">
                <h3>RÃ©partition des objets trouvÃ©s par type {{ data_objets_par_types_gares.gare }}</h3>
                <div>
                    <canvas id="graphique1Barres" style="width: 800px; max-height: 800px;"></canvas>
                </div>
            {% include '/partials/graphiques/graphique_2_barres.html' %}
        </div>

{% endif %}

</div>
{% endblock %}
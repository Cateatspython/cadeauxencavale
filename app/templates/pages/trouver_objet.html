{% extends '/pages/base.html' %}

{% block title %}Recherche d'objets trouvés{% endblock %}

{% block content %}

<h1 class="my-3 text-center">Recherche d'objets trouvés</h1>

<!-- Affichage des messages flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% include '/partials/formulaires/form_trouver_objet.html' %}

<script>
    document.querySelector("form").addEventListener("submit", function() {
    console.log("Valeur des gares soumises :", document.getElementById("hidden-gares").value);
    });
</script>

<div class="m-5">
    <div id="map" style="height: 400px; width: 100%;"></div>
    {% include '/partials/scripts/script_carte_leaflet.html' %}
</div>

    <!-- Affichage des données des gares -->
    {% if donnees %}
        <h2>Résultats</h2>
        <!-- Itération sur la liste de dictionnaires donnees -->
        {% for gare in donnees %}
            <div>
            <h3>{{ gare.nom }}</h3>
            <button class="ajout-favoris-btn" data-uic="{{ gare.UIC }}">Ajouter aux favoris</button>
            <p>Adresse : {{ gare.adresse }}</p>
            <p>Nombre d'objets trouvés pendant la période : {{ gare.nb_objets_trouves_periode_perte_type }}</p>
            <!-- Affichage des horaires seulement si la gare en a -->
            {% if gare.horaires %}
            <h4>Horaires</h4>
            <table>
                <thead>
                    <tr>
                        <td>{{ jour }}</td>
                        <td>{{ horaires.horaires_jour_normal }}</td>
                        <td>{{ horaires.horaires_jour_ferie }}</td>
                    </tr>
                </thead>
                <tbody>
                    {% for jour, horaires in gare.horaires.items() %}
                        <tr>
                            <td>{{ jour }}</td>
                            <td>{{ horaires.horaires_jour_normal }}</td>
                            <td>{{ horaires.horaires_jour_ferie }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
            <!-- Graphique de répartition des objets trouvés par type pour la gare itérée-->
            <div class="container">
                <div class="row">
                    <h4>Répartition des objets trouvés par type - {{ gare.nom }}</h4>
                    <div>
                        <canvas id="graphiqueCamembert_{{ gare.UIC }}" style="width: 100%; max-width: 800px; height: 400px;"></canvas>
                    </div>
                </div>
            </div>
            </div>

        {% endfor %}
        <!-- Inclusion du script pour le graphique camembert -->
        {% include '/partials/graphiques/graphique_1_camembert.html' %}

        <!-- Graphique des objets trouvés par type, par région -->
        <div class="container">
            <div class="row">
                <h4>Répartition des objets trouvés par type - {{ gare.nom }}</h4>
                <div>
                    <canvas id="graphiqueCamembert_{{ gare.UIC }}" style="width: 100%; max-width: 800px; height: 400px;"></canvas>
                </div>
            </div>
        </div>
        </div>

    {% endfor %}

    {% include '/partials/graphiques/graphique_1_camembert.html' %}
    <div class="container">
        <div class="row">
            <h1>Répartition des objets trouvés par type {{ data_objets_par_types_gares.gare }}</h1>
            <div>
                <canvas id="graphique1Barres" style="width: 800px; height: 600px;"></canvas>
            </div>
        </div>
    </div>
    {% include '/partials/graphiques/graphique_2_barres.html' %}
{% endif %}

{% endblock %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for gare in donnees %}
            (function() {  // IIFE pour isoler les variables par itération
                var nomGare = "{{ gare.nom }}";
                var uicGare = "{{ gare.UIC }}";
                var donneesGare = {{ data_objets_par_types_gares | tojson }};
                
                // Trouver le canvas spécifique à cette gare
                var canvas = document.getElementById('graphiqueCamembert_' + uicGare);
                
                if (canvas && donneesGare[nomGare]) {
                    var ctx = canvas.getContext('2d');
                    var objetsGare = donneesGare[nomGare];
                    
                    var labels = objetsGare.map(item => item.type_objet);
                    var valeurs = objetsGare.map(item => item.nb_objets_trouves);
                    
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: valeurs,
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.8)',
                                    'rgba(54, 162, 235, 0.8)',
                                    'rgba(255, 206, 86, 0.8)',
                                    'rgba(75, 192, 192, 0.8)',
                                    'rgba(153, 102, 255, 0.8)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Répartition par type d\'objet - ' + nomGare,
                                    font: {
                                        size: 16
                                    }
                                },
                                legend: {
                                    position: 'right'
                                }
                            }
                        }
                    });
                } else {
                    console.error('Canvas ou données non trouvés pour la gare:', nomGare);
                }
            })();
        {% endfor %}
    });
</script>
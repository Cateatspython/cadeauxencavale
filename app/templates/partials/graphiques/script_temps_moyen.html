<script>
    document.addEventListener('DOMContentLoaded', function() {
        var donnees = {{ donnees_diff_perte_restitution | tojson }};
        
        // Palette de couleurs principales pour les types
        var couleurs_types = [
            '#1f77b4',  // Bleu profond
            '#ff7f0e',  // Orange
            '#2ca02c',  // Vert
            '#d62728',  // Rouge
            '#9467bd',  // Violet
            '#8c564b',  // Marron
            '#e377c2',  // Rose
            '#7f7f7f',  // Gris
            '#bcbd22',  // Olive
            '#17becf',  // Cyan
            '#3498db',  // Bleu clair
            '#e74c3c',  // Rouge corail
            '#2ecc71',  // Vert émeraude
            '#f39c12',  // Orange doré
            '#9b59b6',  // Améthyste
            '#1abc9c'   // Turquoise
        ];
        
        // Fonction pour générer un dégradé de couleurs
        function genererDegrade(couleurBase, nombreNuances) {
            let r = parseInt(couleurBase.slice(1, 3), 16);
            let g = parseInt(couleurBase.slice(3, 5), 16);
            let b = parseInt(couleurBase.slice(5, 7), 16);
            
            let nuances = [];
            for (let i = 0; i < nombreNuances; i++) {
                // Interpolation linéaire vers blanc
                let ratio = i / (nombreNuances - 1);
                let nouveauR = Math.round(r + (255 - r) * ratio);
                let nouveauG = Math.round(g + (255 - g) * ratio);
                let nouveauB = Math.round(b + (255 - b) * ratio);
                
                nuances.push(`rgb(${nouveauR}, ${nouveauG}, ${nouveauB})`);
            }
            
            return nuances;
        }
        
        // Regrouper les données par type d'objet
        var groupes = {};
        donnees.forEach(d => {
            if (!groupes[d.type_objet]) {
                groupes[d.type_objet] = { total: 0, count: 0 };
            }
            groupes[d.type_objet].total += d.delai_moyen_jours;
            groupes[d.type_objet].count += 1;
        });
        
        var types = Object.keys(groupes);
        var delais = types.map(type => groupes[type].total / groupes[type].count);
        
        var trace1 = {
            x: types,
            y: delais,
            type: 'bar',
            name: 'Types d\'objets',
            marker: {
                color: couleurs_types.slice(0, types.length),
                opacity: 0.8
            }
        };
        
        var layout1 = {
            title: 'Délai moyen de restitution par type d\'objet',
            xaxis: { title: 'Type d\'objet' },
            yaxis: { title: 'Délai moyen (jours)' },
            bargap: 0.2
        };
        
        Plotly.newPlot('graph_type', [trace1], layout1);
        
        // Ajout de l'événement de clic
        var graphType = document.getElementById('graph_type');
        graphType.on('plotly_click', function(data) {
            var type_objet_clique = data.points[0].x;
            var couleur_type = data.points[0].fullData.marker.color;
            
            // Filtrer les natures pour le type d'objet cliqué
            var natures_filtrees = donnees.filter(d => d.type_objet === type_objet_clique);
            
            // Regrouper les données par nature d'objet
            var natures_x = natures_filtrees.map(n => n.nature_objet);
            var delais_y = natures_filtrees.map(n => n.delai_moyen_jours);
            
            // Générer un dégradé de la couleur du type
            var couleurs_natures = genererDegrade(couleur_type, natures_x.length);
            
            var trace2 = {
                x: natures_x,
                y: delais_y,
                type: 'bar',
                name: `Natures de ${type_objet_clique}`,
                marker: {
                    color: couleurs_natures,
                    opacity: 0.8
                }
            };
            
            var layout2 = {
                title: `Délai moyen de restitution pour les natures de "${type_objet_clique}"`,
                xaxis: { title: 'Nature d\'objet' },
                yaxis: { title: 'Délai moyen (jours)' },
                bargap: 0.2
            };
            
            Plotly.newPlot('graph_nature', [trace2], layout2);
        });
    });
    </script>